var Tube=function(){var data=[],req=new XMLHttpRequest,requestFeed=function(){req.open("GET","http://cloud.tfl.gov.uk/TrackerNet/LineStatus",!0),req.onload=checkEvents,req.send(null)},checkEvents=function(){if(!req.responseXML)return void(document.getElementsByTagName("body")[0].innerHTML="<p>Error: no connection to internet or TfL feed</p>");for(var items=req.responseXML.getElementsByTagName("LineStatus"),html='<div class="main"><a class="popupclosebtn" title="close popup"></a>',status="",lineName="",className="",buttonText="on",message='<span class="message">No updates set</span>',details=!1,i=0,l=items.length;l>i;i+=1)data[i]?(className="",buttonText="on"):(className="off ",buttonText="off"),status=items[i].getElementsByTagName("Status")[0].getAttribute("Description"),lineName=items[i].getElementsByTagName("Line")[0].getAttribute("Name"),className+=lineName.toLowerCase().replace(/\s/g,"-"),details="Good Service"!==status?items[i].getAttribute("StatusDetails").replace(/GOOD SERVICE/g,"<br />GOOD SERVICE").replace(/MINOR DELAYS/g,"<br />MINOR DELAYS").replace(/A Good Service/g,"<br />A Good Service").replace(/Good Service/g,"<br />Good Service").replace(/No service/g,"<br />No service"):!1,html+='<p class="'+className+'"><a class="toggleBtn" data-class="'+className.replace("off ","")+'" data-pos="'+i+'">',html+='<span class="line">'+lineName+"</span> ",html+='<span class="status">'+status+"</span> "+message+' <span class="toggle on">'+buttonText+"</span>",details&&("<"===details.charAt(0)&&(details=details.substring(6)),html+=' <span class="details">'+details+"</span>"),html+="</p>";var bodyTag=(document.createElement("div"),document.getElementsByTagName("body")[0]);bodyTag.innerHTML=html,setIcon(),document.querySelector(".popupclosebtn").addEventListener("click",function(){window.close()}),settings()},settings=function(){for(var toggle=function(e){e.preventDefault();var setStatus=this.querySelectorAll(".toggle")[0].innerHTML,rowClass=this.getAttribute("data-class"),setTo=0,pos=parseInt(this.getAttribute("data-pos"),10);"on"===setStatus?(this.querySelectorAll(".toggle")[0].innerHTML="off",document.querySelector("."+rowClass).className=rowClass+" off"):(this.querySelectorAll(".toggle")[0].innerHTML="on",setTo=1,document.querySelector("."+rowClass).className=rowClass),data[pos]=0===setTo?!1:!0,storeOptions()},toggleBtns=document.querySelectorAll(".toggleBtn"),i=0,l=toggleBtns.length;l>i;i+=1)toggleBtns[i].addEventListener("click",toggle)},storeOptions=function(){var opt=[],i=0;for(i;13>i;i+=1)opt[i]=data[i]===!0?1:0;localStorage.lines=JSON.stringify(opt),setIcon()},getOptions=function(){var opt=[],i=0;for(opt=JSON.parse(localStorage.lines),i;13>i;i+=1)data[i]=1===opt[i]?!0:!1},setIcon=function(){for(var items=req.responseXML.getElementsByTagName("LineStatus"),description="",minorDelays=0,busService=0,reducedService=0,severeDelays=0,partClosure=0,plannedClosure=0,partSuspended=0,suspended=0,specialService=0,partSuspendedLine="",suspendedLine="",severeDelaysLine="",minorDelaysLine="",specialServiceLine="",plannedClosureLine="",divider=" ",i=0,l=items.length;l>i;i+=1)data[i]&&(divider=" ",description=items[i].getElementsByTagName("Status")[0].getAttribute("Description"),"Suspended"===description?(suspended&&(divider=", "),suspended+=1,suspendedLine+=divider+items[i].getElementsByTagName("Line")[0].getAttribute("Name")+" Line"):"Part Suspended"===description?(partSuspended&&(divider=", "),partSuspended+=1,partSuspendedLine+=divider+items[i].getElementsByTagName("Line")[0].getAttribute("Name")+" Line"):"Planned Closure"===description||"Service Closed"===description?(plannedClosure&&(divider=", "),plannedClosure+=1,plannedClosureLine+=divider+items[i].getElementsByTagName("Line")[0].getAttribute("Name")+" Line"):"Part Closure"===description?partClosure+=1:"Severe Delays"===description?(severeDelays&&(divider=", "),severeDelays+=1,severeDelaysLine+=divider+items[i].getElementsByTagName("Line")[0].getAttribute("Name")+" Line"):"Special Service"===description?(specialService&&(divider=", "),specialService+=1,specialServiceLine+=divider+items[i].getElementsByTagName("Line")[0].getAttribute("Name")+" Line"):"Reduced Service"===description?reducedService+=1:"Bus Service"===description?busService+=1:"Minor Delays"===description&&(minorDelays&&(divider=", "),minorDelays+=1,minorDelaysLine+=divider+items[i].getElementsByTagName("Line")[0].getAttribute("Name")+" Line"));plannedClosure>0?(chrome.browserAction.setIcon({path:"images/bad.png"}),chrome.browserAction.setTitle({title:plannedClosureLine+" closed"})):suspended>0?(chrome.browserAction.setIcon({path:"images/bad.png"}),chrome.browserAction.setTitle({title:suspendedLine+" suspended"})):partSuspended>0?(chrome.browserAction.setIcon({path:"images/bad.png"}),chrome.browserAction.setTitle({title:partSuspendedLine+" part suspended"})):severeDelays>0?(chrome.browserAction.setIcon({path:"images/bad.png"}),chrome.browserAction.setTitle({title:severeDelaysLine+" severe delays"})):specialService>0?(chrome.browserAction.setIcon({path:"images/delay.png"}),chrome.browserAction.setTitle({title:specialServiceLine+" special service"})):minorDelays>0?(chrome.browserAction.setIcon({path:"images/delay.png"}),chrome.browserAction.setTitle({title:minorDelaysLine+" minor delays"})):(chrome.browserAction.setIcon({path:"images/good.png"}),chrome.browserAction.setTitle({title:"No issues reported"}))},getActiveLines=function(){if(localStorage.lines)getOptions();else{for(var i=0;13>i;i+=1)data[i]=!0;storeOptions()}};return{update:function(){requestFeed()},init:function(){getActiveLines(),requestFeed()}()}}(),_gaq=_gaq||[];_gaq.push(["_setAccount","UA-2103529-14"]),_gaq.push(["_trackPageview"]),function(){var ga=document.createElement("script");ga.type="text/javascript",ga.async=!0,ga.src="https://ssl.google-analytics.com/ga.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga,s)}();